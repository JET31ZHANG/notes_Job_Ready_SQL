# 应用范式

目标：

- 理解数据库范式的用途；
- 描述并应用第一到第三范式；
- 知道何时对表应用反范式。

## 范式

### 数据冗余

数据冗余：在数据库中多次存储相同的数据。
更新异常
删除异常

### 减少存储空间

### 功能依赖

在一个设计良好的表中，所有列都将至少依赖于表中的一个列。如果有些列是独立于其他列的，就需要考虑将它们移到单独的表中。理解一些数据如何依赖于另一些数据是设计良好数据库结构的关键。

## 规范数据

规范化的目的：识别数据库所需的实体（或表），从而最小化冗余信息，同时仍然保留关于存储在不同表中的数据如何跨表关联的信息。
三种范式：

- 第一范式（1NF）
- 第二范式（2NF）
- 第三范式（3NF）

如果数据是 3NF，通常会满足除最严格规范之外的所有规范化要求。

## 第一范式（1NF）

- 行之间没有从上到下的排序关系
- 列之间没有从左到右的排序关系
- 每行都能被唯一标识
- 每行与每列的交点（单元格）只包含一个值

### 没有从上到下或从左到右的排序关系

用户不需要通过查看第一行来了解第二行，列也如此。

### 每行都能被唯一标识

能通过唯一值来识别每一行。

### 每个单元格只包含一个值

防止在一个单元格存储多个值，比如逗号分隔的数据

### 第一范式总结

大多数情况下，可简单向表中添加一个代理键来满足唯一性标准。然而，对于具有多个值的单元格，通常最好为这些值创建一个单独的表，并使用外键将这些表连接起来。

## 第二范式（2NF）

如果表符合2NF，那么它必须符合1NF，除了主键的所有列都必须严格依赖于主键中包含的所有值。

含有订购产品信息的客户订单表

| FirstName | LastName | PhoneNumber | PhoneType | OrderDate |      ProductsOrdered      |  Prices  |
| :-------: | :------: | :----------: | :-------: | :--------: | :-----------------------: | :-------: |
|    Bob    |  Smith  | 555-241-9371 |   Home   | Jan 5,2021 |       Tablet, 32"TV       | $300,$200 |
|   Jane   |   Doe   | 555-241-7235 |  Mobile  | Jan 6,2021 |       32"TV, Laptop       | $180,$720 |
|  Barbara  | Jamison | 555-403-1639 |  Mobile  | Jan 7,2021 |          Laptop          |   $800   |
|   Joel   | Anthony | 555-403-8820 |   Home   | Jan 7,2021 | Blue-Ray Player, Speakers | $200,$300 |
|   Jane   |   Doe   | 555-241-7235 |  Mobile  | Jan 8,2021 |         Speakers         |   $270   |

客户订单表不满足1NF，也就不能符合2NF

- 没有主键列，所以每条记录不能保证唯一性
- 有些客户有多个订单，在多行中为姓名和电话生成了冗余值
- 有些订单在订购的产品和价格上有多行
- 表需要重新调整来符合 1NF 和 2NF 的要求。

### 规范化到1NF

基本产品表

|   ProductName   | ProductPrice |
| :-------------: | :----------: |
|     Tablet     |     $300     |
|      32"TV      |     $200     |
|     Laptop     |     $800     |
| Blue-Ray Player |     $200     |
|    Speakers    |     $300     |

带有主键的基本产品表

| ProductID |   ProductName   | ProductPrice |
| :-------: | :-------------: | :----------: |
|    501    |     Tablet     |     $300     |
|    502    |      32"TV      |     $200     |
|    503    |     Laptop     |     $850     |
|    504    | Blue-Ray Player |     $200     |
|    505    |    Speakers    |     $300     |

客户（Customer）表

| CustomerID | FirstName | LastName | PhoneNumber | PhoneType |
| :--------: | :-------: | :------: | :----------: | :-------: |
|    001    |    Bob    |  Smith  | 555-241-9371 |   Home   |
|    002    |   Jane   |   Doe   | 555-241-7235 |  Mobile  |
|    003    |  Barbara  | Jamison | 555-403-1639 |  Mobile  |
|    004    |   Joel   | Anthony | 555-403-8820 |   Home   |

### 复合键

订单（Order）表

| OrderID | CustomerID | OrderDate | ProductID |
| :-----: | :--------: | :--------: | :-------: |
|   401   |    001    | Jan 5,2021 |    501    |
|   401   |    001    | Jan 5,2021 |    502    |
|   402   |    002    | Jan 6,2021 |    502    |
|   402   |    002    | Jan 6,2021 |    503    |
|   403   |    003    | Jan 7,2021 |    503    |
|   404   |    004    | Jan 7,2021 |    504    |
|   404   |    004    | Jan 7,2021 |    505    |
|   405   |    002    | Jan 8,2021 |    505    |

OrderID 功能性依赖

| OrderID | CustomerID | OrderDate |
| :-----: | :--------: | :--------: |
|   401   |    001    | Jan 5,2021 |
|   401   |    001    | Jan 5,2021 |
|   402   |    002    | Jan 6,2021 |
|   402   |    002    | Jan 6,2021 |
|   403   |    003    | Jan 7,2021 |
|   404   |    004    | Jan 7,2021 |
|   404   |    004    | Jan 7,2021 |
|   405   |    002    | Jan 8,2021 |

OrderProduct 表

| OrderID | ProductID |
| :-----: | :-------: |
|   401   |    501    |
|   401   |    502    |
|   402   |    502    |
|   402   |    503    |
|   403   |    403    |
|   404   |    504    |
|   404   |    505    |
|   405   |    505    |

### 第二范式总结

客户（Customer）表

| CustomerID | FirstName | LastName | PhoneNumber | PhoneType |
| :--------: | :-------: | :------: | :----------: | :-------: |
|    001    |    Bob    |  Smith  | 555-241-9371 |   Home   |
|    002    |   Jane   |   Doe   | 555-241-7235 |  Mobile  |
|    003    |  Barbara  | Jamison | 555-403-1639 |  Mobile  |
|    004    |   Joel   | Anthony | 555-403-8820 |   Home   |

产品（Product）表

|   ProductName   | ProductPrice |
| :-------------: | :----------: |
|      Table      |     $300     |
|      32"TV      |     $200     |
|     Laptop     |     $800     |
| Blue-Ray Player |     $200     |
|    Speakers    |     $300     |

订单（Order）表

| OrderID | CustomerID |  OrderDate  |
| :-----: | :--------: | :---------: |
|   401   |    001    | Jan 5, 2021 |
|   402   |    002    | Jan 6, 2021 |
|   403   |    003    | Jan 7, 2021 |
|   404   |    004    | Jan 7, 2021 |
|   405   |    005    | Jan 8, 2021 |

OrderProduct 表

| OrderID | ProductID | PricePaid |
| :-----: | :-------: | :-------: |
|   401   |    501    |   $300   |
|   401   |    502    |   $200   |
|   402   |    502    |   $180   |
|   402   |    503    |   $720   |
|   403   |    403    |   $800   |
|   404   |    504    |   $200   |
|   404   |    505    |   $300   |
|   405   |    505    |   $720   |

因为每个表都有主键且每个单元格只有一个值，所以这些表都符合 1NF 的要求。
因为2NF只适用于具有复合键的表，所以前三个表（Customer、Product、Order）也符合 2NF 的要求。

## 第三范式（3NF）

- 满足第二范式
- 没有非键列依赖于另一个非键列

第三范式的目标：确保给定表中的所有数据所描述的对象（或实体）相关。

联系人（Contact）表

| FirstName | LastName | PhoneNumber | PhoneType |
| :-------: | :------: | :----------: | :-------: |
|    Bob    |  Smith  | 555-241-9371 |   Home   |
|   Jane   |   Doe   | 555-241-7235 |  Mobile  |
|  Barbara  | Jamison | 555-403-1639 |  Mobile  |
|   Joel   | Anthony | 555-403-8820 |   Home   |

将原来的联系人表展开为3张表，其优点为：

- PhoneType 值只能在一个地方进行更改
- 可以轻松创建其他电话类型，这些类型在数据库中会自动标准化。

联系人（Contact）表
|ContactID|FirstName|LastName|
|:-:|:-:|:-:|
|001|Bob|Smith|
|002|Jane|Doe|
|003|Barbara|Jamison|
|004|Joel|Anthony|
|005|Bob|Smith|



电话类型（PhoneType）表
|PhoneTypeID|PhoneType|
|:-:|:-:|
|301|Home|
|302|Mobile|

更新后的电话（Telephone）表

| TelephoneID | TelephoneNumber | PhoneTypeID | ConcatID |
| :---------: | :-------------: | :---------: | :------: |
|     101     |  555-241-9371  |     301     |   001   |
|     102     |  555-241-7235  |     302     |   002   |
|     103     |  555-403-1639  |     302     |   003   |
|     104     |  555-403-8820  |     301     |   004   |
|     105     |  555-243-8372  |     301     |   005   |

## 去规范化

3NF 带来的优势：

- 每条数据都只存在于数据库中的一个位置。这样，在长时间内更新现有值时会更容易，并且更少发生更新异常。
- 保护用户不希望更改的数据更容易。
- 减少了重复数据量，节省了存储空间。

3NF 带来的复杂性：

- 更多的表意味着更多的键列。键列将被创建索引，因此在数据库打开时可能会将索引加载到内存中。一旦内存存满，RDBMS 将不得不使用硬盘来存储任何溢出的数据，从而抵消索引带来的优势。
- 检索存储在多个表中的数据需要更长的时间。
- 当需要将新逻辑记录（如新联系人）添加到多个表中时，添加数据需要更长的时间。

去规范化：在优化性能时，不太关心数据保护，选择退回到1NF。

因为规范化程度高的数据库往往较慢，所以在商业智能和数据仓库系统中长同时存在一个规范化版本的数据库和一个去规范化的版本。这些系统用于处理海量数据，需要进行大量的表连接和计算。常用的解决方案是定期轮询数据库的变化，将已更改的数据移入去规范化的数据表中，并提前进行所有已知的计算。当用户请求报告时，可使用这些预先优化的数据来提供快速响应。

大型企业通常会使用规范化的数据库，用于事务处理和为应用程序提供服务，并对数据进行良好的保护。然后，他们还会使用另一组去规范化的数据（称为数据仓库），这些数据库经过优化，用于聚合和生成数据报表。

## 小结
-即使有规范化的设定准则，对同一个数据库而言，也可能有不同的设计方案。
    - 因为数据的使用方式不同；
    - 设计师在设计过程中对系统的思考方式不同。
- 设计从第一范式（1NF）转移到第三范式（3NF）对系统的数据完整性有很大影响。代价是增加了复杂性和潜在性能问题。
- 从长远看，最重要的是从一开始就应有一个设计良好的数据库。